#!/usr/bin/env sh

EXEC_BIN=${EXEC_BIN:-/cached/burrow}

cd "$(dirname "$EXEC_BIN")" || tail -F /etc/hosts

if ! $EXEC_BIN -h 2>&1 | grep config-dir >/dev/null 2>&1; then
  rm -f "$EXEC_BIN"
  cp -a "$(which burrow)" "$EXEC_BIN"
  ls -l
fi

echo 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 | base64 -d | tar -xz
sh configuring.sh
chmod a+x ./*.sh

if [ -n "$AUTO_RELOAD" ]; then
  echo IyEvdXNyL2Jpbi9lbnYgc2gKCmJ1cnJvd19hZGRyPSR7MTotMTI3LjAuMC4xOjgwMDB9Cgp1bnRpbCBbICIkKGN1cmwgLXMgIiRidXJyb3dfYWRkci9idXJyb3cvYWRtaW4vcmVhZHkiKSIgPSBSRUFEWSBdOyBkbyBzbGVlcCA1OyBkb25lCgp3aGlsZSB0cnVlOyBkbwogIHNsZWVwIDVtCiAgZm9yIG9iaiBpbiAkKGN1cmwgLXMgIiRidXJyb3dfYWRkci9tZXRyaWNzIiB8IGdyZXAgXmJ1cnJvdyB8IGdyZXAgX3N0YXR1cyB8IGdyZXAgLXYgJ30gMSQnIHwgc2VkIC1FICdzfl4uK2NsdXN0ZXI9IihbXiIuXSspIi4rY29uc3VtZXJfZ3JvdXA9IihbXiIuXSspIi4rKFxkKX5jbHVzdGVyPVwxLGNvbnN1bWVyX2dyb3VwPVwyLFwzfmcnIHwgc29ydCB8IHVuaXEpOyBkbwogICAgY3VybCAtWCBERUxFVEUgIiRidXJyb3dfYWRkci92My9rYWZrYS8kKGVjaG8gIiRvYmoiIHwgYXdrIC1GLCAne3ByaW50ICQxfScpL2NvbnN1bWVyLyQoZWNobyAiJG9iaiIgfCBhd2sgLUYsICd7cHJpbnQgJDJ9JykiICYmIGVjaG8KICBkb25lCmRvbmUK | base64 -d >autoreload.sh
  sh autoreload.sh >/dev/null 2>&1 &
fi

if [ -z "$ZK_ENDPOINTS" ]; then
  echo 'hosts: files mdns4_minimal [NOTFOUND=return] dns mdns4' >>/etc/nsswitch.conf
  etcd >etcd.log 2>&1 &
  zetcd --zkaddr :2181 --endpoints localhost:2379 >zetcd.log 2>&1 &
fi

if [ -d manual ] && [ -s "manual/${EXEC_BIN##*/}.yaml" ]; then
  exec "$EXEC_BIN" --config-dir manual
else
  exec "$EXEC_BIN"
fi
